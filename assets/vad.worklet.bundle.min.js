(()=>{"use strict";var e={710:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.log=t.LOG_PREFIX=void 0,t.LOG_PREFIX="[VAD]";const s=["error","debug","warn"].reduce(((e,s)=>(e[s]=function(e){return(...s)=>{console[e](t.LOG_PREFIX,...s)}}(s),e)),{});t.log=s},954:(e,t)=>{var s;Object.defineProperty(t,"__esModule",{value:!0}),t.Message=void 0,function(e){e.AudioFrame="AUDIO_FRAME",e.SpeechStart="SPEECH_START",e.VADMisfire="VAD_MISFIRE",e.SpeechEnd="SPEECH_END",e.SpeechStop="SPEECH_STOP",e.SpeechRealStart="SPEECH_REAL_START",e.FrameProcessed="FRAME_PROCESSED"}(s||(t.Message=s={}))},825:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Resampler=void 0;const i=s(710);t.Resampler=class{constructor(e){this.options=e,this.lastFilteredValue=0,this.FILTER_COEFFICIENT=.2,this.process=e=>{const t=[];for(const s of e)for(this.inputBuffer.push(s);this.hasEnoughDataForFrame();){const e=this.generateOutputFrame();t.push(e)}return t},e.nativeSampleRate<16e3&&i.log.debug("nativeSampleRate is too low. Should have 16000 = targetSampleRate <= nativeSampleRate, will be upsampled"),this.inputBuffer=[]}async*stream(e){for(const t of e)for(this.inputBuffer.push(t);this.hasEnoughDataForFrame();){const e=this.generateOutputFrame();yield e}}hasEnoughDataForFrame(){return this.inputBuffer.length*this.options.targetSampleRate/this.options.nativeSampleRate>=this.options.targetFrameSize}lowPassFilter(e){return this.lastFilteredValue=this.lastFilteredValue+this.FILTER_COEFFICIENT*(e-this.lastFilteredValue),this.lastFilteredValue}generateOutputFrame(){const e=new Float32Array(this.options.targetFrameSize);if(this.options.nativeSampleRate/this.options.targetSampleRate<1){const t=this.options.targetSampleRate/this.options.nativeSampleRate;for(let s=0;s<this.options.targetFrameSize;s++){const i=s/t,r=Math.floor(i),a=i-r;if(r+1<this.inputBuffer.length){const t=this.lowPassFilter(this.inputBuffer[r]||0),i=this.lowPassFilter(this.inputBuffer[r+1]||0);e[s]=t+a*(i-t)}else e[s]=this.lowPassFilter(this.inputBuffer[r]||0)}const s=Math.ceil(this.options.targetFrameSize/t);this.inputBuffer=this.inputBuffer.slice(s)}else{let t=0,s=0;for(;t<this.options.targetFrameSize;){let i=0,r=0;for(;s<Math.min(this.inputBuffer.length,(t+1)*this.options.nativeSampleRate/this.options.targetSampleRate);){const e=this.inputBuffer[s];void 0!==e&&(i+=e,r++),s++}e[t]=i/r,t++}this.inputBuffer=this.inputBuffer.slice(s)}return e}}}},t={};function s(i){var r=t[i];if(void 0!==r)return r.exports;var a=t[i]={exports:{}};return e[i](a,a.exports,s),a.exports}(()=>{const e=s(710),t=s(954),i=s(825);class r extends AudioWorkletProcessor{constructor(s){super(),this._initialized=!1,this._stopProcessing=!1,this.init=async()=>{e.log.debug("initializing worklet"),this.resampler=new i.Resampler({nativeSampleRate:sampleRate,targetSampleRate:16e3,targetFrameSize:this.options.frameSamples}),this._initialized=!0,e.log.debug("initialized worklet")},this.options=s.processorOptions,this.port.onmessage=e=>{e.data.message===t.Message.SpeechStop&&(this._stopProcessing=!0)},this.init()}process(e,s,i){if(this._stopProcessing)return!1;const r=e[0][0];if(this._initialized&&r instanceof Float32Array){const e=this.resampler.process(r);for(const s of e)this.port.postMessage({message:t.Message.AudioFrame,data:s.buffer},[s.buffer])}return!0}}registerProcessor("vad-helper-worklet",r)})()})();